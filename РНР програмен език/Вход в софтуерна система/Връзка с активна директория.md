<p>алабала<br />&lt;?php<br />/**<br /> * Проверява дали потребителят съществува и паролата му е валидна.<br /> *<br /> * @param string $user SAM-Account-Name (без домейн, примерно &bdquo;ivan.georgiev&ldquo;)<br /> * @param string $password<br /> * @param string $domain NT-домейн (NETBIOS) &ndash; примерно &bdquo;MYCOMPANY&ldquo;<br /> * @param string $baseDN Base DN за търсене &ndash; примерно &bdquo;DC=mycompany,DC=local&ldquo;<br /> * @param string $ldapHost LDAP сървър &ndash; примерно &bdquo;dc01.mycompany.local&ldquo;<br /> * @param int $ldapPort 389 (LDAP) или 636 (LDAPS)<br /> * @return bool<br /> */<br />function adAuthenticate(<br /> string $user,<br /> string $password,<br /> string $domain,<br /> string $baseDN,<br /> string $ldapHost = 'dc01.mycompany.local',<br /> int $ldapPort = 389<br />): bool {<br /> // 1. Формираме &bdquo;UPN&ldquo; или &bdquo;NT-style&ldquo; потребител<br /> $userUPN = $user . '@' . strtolower($domain); // ivan.georgiev@mycompany.local<br /> // Алтернативно: $userNT = $domain . '\\' . $user; // MYCOMPANY\ivan.georgiev</p>
<p>// 2. Включваме LDAP протокола<br /> $ldap = ldap_connect($ldapHost, $ldapPort);<br /> if (!$ldap) {<br /> error_log('LDAP connect failed');<br /> return false;<br /> }</p>
<p>// 3. Задължителни опции за AD (протокол версия и реферали)<br /> ldap_set_option($ldap, LDAP_OPT_PROTOCOL_VERSION, 3);<br /> ldap_set_option($ldap, LDAP_OPT_REFERRALS, 0); // 0 за AD</p>
<p>// 4. Опит за &bdquo;bind&ldquo; = удостоверяване<br /> $bind = @ldap_bind($ldap, $userUPN, $password);<br /> if (!$bind) {<br /> error_log('LDAP bind failed: ' . ldap_error($ldap));<br /> ldap_close($ldap);<br /> return false;<br /> }</p>
<p>// 5. (По желание) Допълнително търсене на потребителя<br /> $filter = '(sAMAccountName=' . ldap_escape($user, '', LDAP_ESCAPE_FILTER) . ')';<br /> $search = ldap_search($ldap, $baseDN, $filter, ['displayName', 'mail']);<br /> if ($search) {<br /> $entries = ldap_get_entries($ldap, $search);<br /> if ($entries['count'] &gt; 0) {<br /> // Потребителят е намерен &ndash; можем да ползваме displayName, mail и др.<br /> }<br /> }</p>
<p>// 6. Затваряме връзката<br /> ldap_close($ldap);<br /> return true;<br />}</p>
<p>/* ---------------- Примерно използване ---------------- */<br />if (adAuthenticate('ivan.georgiev', 'MySecretPass', 'MYCOMPANY', 'DC=mycompany,DC=local')) {<br /> echo "Успешен вход!";<br />} else {<br /> echo "Грешно потребителско име или парола.";<br />}<br />?&gt;<br /><br /><br /></p>
<div class="paragraph">Какво трябва да имате предвид:</div>
<ol start="1">
<li>
<div class="paragraph">PHP трябва да е компилиран с разширението <code class="segment-code-inline" data-v-7caec4f8="" data-v-fc0d0c5a="">ldap</code> (<code class="segment-code-inline" data-v-7caec4f8="" data-v-fc0d0c5a="">extension=ldap</code> в php.ini).</div>
</li>
<li>
<div class="paragraph">От PHP 7.2+ функцията <code class="segment-code-inline" data-v-7caec4f8="" data-v-fc0d0c5a="">ldap_escape()</code> вече е налична.</div>
</li>
<li>
<div class="paragraph">Ако ползвате LDAPS (порт 636) сложете <code class="segment-code-inline" data-v-7caec4f8="" data-v-fc0d0c5a="">ldaps://</code> в <code class="segment-code-inline" data-v-7caec4f8="" data-v-fc0d0c5a="">$ldapHost</code> и инсталирайте коректния SSL сертификат на сървъра; иначе свържете на 389 и оставете обикновен LDAP.</div>
</li>
<li>
<div class="paragraph">Потребителят, с който тествате, трябва да има права за четене на AD (обикновено всеки валиден акаунт стига).</div>
</li>
<li>
<div class="paragraph">Горният пример работи директно срещу Active Directory; за OpenLDAP променяте <code class="segment-code-inline" data-v-7caec4f8="" data-v-fc0d0c5a="">baseDN</code> и <code class="segment-code-inline" data-v-7caec4f8="" data-v-fc0d0c5a="">filter</code>-а.</div>
</li>
</ol>
<div class="paragraph">Това е всичко необходимо, за да &bdquo;влезете&ldquo; в Active Directory от PHP.</div>